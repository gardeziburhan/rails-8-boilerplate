#!/usr/bin/env bash
set -euo pipefail

ROOT_DIR="$(cd "$(dirname "$0")/.." && pwd)"
cd "$ROOT_DIR"

if ! command -v npm >/dev/null 2>&1; then
  echo "npm is required to start the Vite dev server." >&2
  exit 1
fi

if ! command -v node >/dev/null 2>&1; then
  echo "Node.js is required to start the Vite dev server." >&2
  exit 1
fi

NODE_MIN_VERSION="20.19.0"
NODE_VERSION_RAW="$(node -v 2>/dev/null || true)"
NODE_VERSION="${NODE_VERSION_RAW#v}"

if [ -n "$NODE_VERSION" ]; then
  if [ "$(printf '%s\n%s\n' "$NODE_MIN_VERSION" "$NODE_VERSION" | sort -V | head -n1)" != "$NODE_MIN_VERSION" ]; then
    cat <<EOF >&2
Node.js $NODE_MIN_VERSION or newer is required (package engines for Vite and React Router).
You are running: ${NODE_VERSION_RAW:-unknown}
Please upgrade Node.js and re-run bin/dev.
EOF
    exit 1
  fi
fi

if [ ! -d "${ROOT_DIR}/node_modules" ]; then
  echo "Installing Node dependencies..."
  npm install
fi

echo "Starting Vite dev server..."
npm run dev -- --host --clearScreen=false &
VITE_PID=$!

echo "Starting Rails server..."
"${ROOT_DIR}/bin/rails" server "$@" &
RAILS_PID=$!

pids=(${VITE_PID} ${RAILS_PID})

cleanup() {
  for pid in "${pids[@]}"; do
    if kill -0 "$pid" >/dev/null 2>&1; then
      kill "$pid" >/dev/null 2>&1 || true
    fi
  done
}

trap cleanup EXIT INT TERM

wait -n "${pids[@]}"
exit_code=$?
cleanup
exit "$exit_code"